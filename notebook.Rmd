---
title: "Women in STEM"
author: "Heidi Blackburn & Jason Heppler"
date: "3/28/2019"
output: tint::tintHtml
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The following notebook analyzes gender in STEM publications. The content was developed by Heidi Blackburn and Jason Heppler, University of Nebraska at Omaha. Last updated **April 19, 2019**.

```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(gender)
library(tidygraph)
library(ggraph)
library(network)
library(jahMisc)
library(DT)
library(plotly)
```


```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Read data
#data <- readxl::read_xlsx("data-raw/Heidi_gender_data4.xlsx")
data <- readxl::read_xlsx("data-raw/WiSTEM Data9.xlsx")
```


```{r, echo=FALSE, error=FALSE, warning=FALSE}
## Data cleanup
# Rename columns to make it easier for writing scripts.
data <- data %>% 
  rename(author = "Author") %>% 
  rename(title = "Title") %>% 
  rename(pubtitle = "Publication Title") %>% 
  rename(publisher = "Publisher") %>% 
  rename(date = "Date") 

data <- data %>%
  lapply(function(x){
    gsub("Proceedings of the ASEE Annual Conference & Exposition", "ASEE Annual Conference and Exposition, Conference Proceedings", x)
  })
data <- data %>% as.data.frame()
```

```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Gender prediction -------------------------------------------------------
# We're attempting to predict the gender of the authors based on their first 
# names. The scripts below do a few things:
# 1. We separate the authors into their own rows based on the ";" delimiter in
#    the author column.
# 2. We separate names into individual first_name and last_name columns
# 3. We create a temporary year 2012 for the `gender` package to use
# 4. We predict gender based on first name using `gender_df`

# Separate out authors into their own rows
data_clean <- separate_rows(data, author, sep = ";")

# The below code is designed to clean up names and prep them to predict gender
data_predict <- separate(data_clean, c("lastn", "firstn"), col = "author", sep = ",")
data_predict$fname <- gsub("(.*)\\s+[A-Z]\\.?$", "\\1", data_predict$firstn)
data_predict$fname <- str_trim(data_predict$fname)
data_predict <- data_predict %>% 
  select(lastn, fname, pubtitle, date) %>% 
  mutate(tmpyear = 2012)
data_predict <- mutate(data_predict, id = rownames(data_predict))

# Predict gender of author using `gender_df`
gender_predicted <- gender_df(data_predict, name_col = "fname", year_col = "tmpyear", method = "ssa")
gender_predicted$fname <- gender_predicted$name

gender_predicted_final <- merge(gender_predicted, data_predict, all = TRUE)
gender_predicted_final$author <- paste(gender_predicted_final$lastn, gender_predicted_final$fname, sep = ", ")
gender_predicted_final <- gender_predicted_final %>% 
  select(author, fname, lastn, gender, pubtitle, date, id)
gender_predicted_final$author <- str_trim(gender_predicted_final$author)
```

```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Conferences and journals -----------------------------------------------------
# Separate out journal articles from conference proceedings.

conferences <- data %>% 
  filter(str_detect(pubtitle, "Conference|Proceedings"))
journals <- data %>% 
  filter(!str_detect(pubtitle, "Conference|Proceedings"))
```


# Data analytics

### Count of authors by gender.

```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Count genders
DT::datatable(
gender_predicted_final %>% 
  group_by(gender) %>% 
  tally %>% 
  arrange(desc(n)) %>% 
  head(10)
)
```
 
### Top publications by number of articles.

```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Top journals
DT::datatable(journals %>% 
  group_by(pubtitle) %>% 
  tally %>% 
  arrange(desc(n))
)
```

### Top conference publications by number of article.

```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Top conferences
DT::datatable(conferences %>% 
  group_by(pubtitle) %>% 
  tally %>% 
  arrange(desc(n))
)
```

```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Create a dataset that includes the publication type (journal vs. conference)
conferences_gender <- gender_predicted_final %>% 
  filter(str_detect(pubtitle, "Conference|Proceedings"))
journals_gender <- gender_predicted_final %>% 
  filter(!str_detect(pubtitle, "Conference|Proceedings"))

journal_mutate <- journals_gender %>% mutate(pubtype = "journal") 
conf_mutate <- conferences_gender %>% mutate(pubtype = "conference") 
conf_journal_merged <- bind_rows(journal_mutate, conf_mutate)
```

### Top publications (including journals and conference proceedings.)

```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Top publications (all)
DT::datatable(count(data, pubtitle, sort = TRUE))
```

### Number of publications by year.

```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Top publication years
DT::datatable(data %>% 
  group_by(date) %>% 
  tally %>% 
  arrange(desc(n))
)
```

### Total number of articles.

```{r, echo=FALSE, error=FALSE, warning=FALSE}
# Total number of articles
pub_counts <- count(data, pubtitle, sort = TRUE)
DT::datatable(pub_counts)
```

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# Authorship order 

# NB: Use data from WiSTEM Data9.xlsx for lists of authors
data_name_listed <- readxl::read_xlsx("data-raw/WiSTEM Data9.xlsx")

# Rename columns for easier manipulation
data_name_listed <- data_name_listed %>% 
  rename(author = "Author") %>% 
  rename(title = "Title") %>% 
  rename(pubtitle = "Publication Title") %>% 
  rename(publisher = "Publisher") %>% 
  rename(date = "Date") 

# Separate lists of names into columns according to the order they appear in 
# the comma-separated list
data_name_listed <- mutate(data_name_listed, id = row_number())
data_name_order <- data_name_listed %>%
  select(author) %>%
  transmute(
    id = row_number(),
    author = strsplit(author, ";")
  ) %>%
  unnest() %>%
  group_by(id) %>%
  mutate(
    position = row_number(),
    author = trimws(author)
  ) %>%
  ungroup()

# Clean up data and remove special characters
data_name_order$author <- gsub("(.*)\\s+[A-Z]\\.?$", "\\1", data_name_order$author)

# Merge name order with analysis dataset
data_name_order <- merge(data_name_order, gender_predicted_final, by = "author")
```

# Data plots

### The top publications per year. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# Plot the number of publications per year
p <- ggplot(gender_predicted_final, aes(x = date)) +
  geom_bar() +
  theme_minimal()

ggplotly(p)
```

### The number of articles per publication.

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# Plot the number of articles per publication
p1 <- ggplot(data, aes(x = pubtitle)) +
  geom_bar() +
  theme_minimal()
ggplotly(p1)
```

### Authorship by position.

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# Authorship by position
# Useful chart.
p2 <- ggplot(data_name_order, aes(position)) +
  geom_bar() +
  facet_grid(. ~ gender) +
  theme_light()
ggplotly(p2)
```

### Stacked barchart of gender by year.

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# Stacked barchart of gender by year
# Useful chart.
p3 <- ggplot(data_name_order, aes(x = date, fill = gender)) +
  geom_bar() +
  theme_minimal()
ggplotly(p3)
```

### Gender by journal vs. conference.

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# Gender by journal vs. conference
# Useful chart.
p4 <- ggplot(conf_journal_merged, aes(x = date, fill = gender)) +
  geom_bar() +
  facet_grid(~ pubtype) +
  theme_light()
ggplotly(p4)
```

### Counting the number of authors by position.

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# Counting the number of authors by position
p5 <- data_name_order %>% 
  count(position) %>% 
  ggplot(aes(x = position, y = n)) + geom_bar(stat = "identity") +
  theme_minimal()
ggplotly(p5)
```

# Network analysis

We want to look at two networks:

1. Where do people publish most often (bimodal)
2. Who publishes with each other

```{r, message=FALSE, echo=FALSE, warning=FALSE}
# Separate out data to a 'source'
sources <- gender_predicted_final %>% 
  distinct(author, gender) %>% 
  dplyr::rename(label = author) %>% 
  mutate(type = "author")

# Separate out data to a 'target'
destinations <- gender_predicted_final %>% 
  distinct(pubtitle) %>% 
  dplyr::rename(label = pubtitle) %>% 
  mutate(type = "publication")

# Join source and target together and add a unique ID
nodes <- full_join(sources, destinations, by = "label")
nodes <- nodes %>% rowid_to_column('id')
nodes[is.na(nodes)] = ''
nodes <- nodes %>% unite(type, c(type.x, type.y), remove = FALSE, sep='')
nodes <- nodes %>% select(id, label, gender, type)

# Generate a nodes (author) set
nodes_gender <- nodes %>% filter(type == "author")

# Generate a nodes (publication) set
publications <- gender_predicted_final %>% 
  dplyr::group_by(author, pubtitle) %>% 
  dplyr::summarise(weight = n()) %>% 
  dplyr::ungroup()

# Generate edges for publications
edges <- publications %>% 
  left_join(nodes, by = c("author" = "label")) %>% 
  dplyr::rename(from = id)

# Generate edges for authors
edges <- edges %>% 
  left_join(nodes, by = c("pubtitle" = "label")) %>% 
  dplyr::rename(to = id)

# Final edges
edges <- select(edges, from, to, weight)
edges_gender <- publications %>% 
  left_join(nodes_gender, by = c("author" = "label")) %>% 
  dplyr::rename(from = id)
edges_gender <- edges_gender %>%
  left_join(nodes_gender, by = c("author" = "label")) %>% 
  dplyr::rename(to = id)

# Final edges by gender
edges_gender <- select(edges_gender, from, to, weight)

# Prepare network data: network (publication types) and network (gender)
network <- network(edges, vertex.attr = nodes, matrix.type = "edgelist", ignore.eval = FALSE)
network_gender <- network(edges_gender, vertex.attr = nodes_gender, matrix.type = "edgelist", ignore.eval = FALSE)

nodes_tidy <- tbl_graph(nodes = nodes, edges = edges, directed = FALSE)
graph_tidy <- nodes_tidy %>% 
  activate(nodes) %>% 
  filter(!node_is_isolated()) %>% 
  mutate(degree = centrality_degree()) %>% 
  activate(edges) %>% 
  arrange(desc(weight))

gender_nodes_tidy <- tbl_graph(nodes = nodes_gender, edges = edges_gender, directed = FALSE)
gender_tidy <- gender_nodes_tidy %>% 
  activate(nodes) %>% 
  filter(!node_is_isolated()) %>% 
  mutate(degree = centrality_degree()) %>% 
  activate(edges) %>% 
  arrange(desc(weight))

edges <- edges %>% dplyr::rename(source = from) %>% dplyr::rename(target = to)
```

Graph of authors and publications bimodal network, colored by author and publication.

```{r, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
# Graph: Authors and publications bimodal network colored by 
# author and publication
ggraph(graph_tidy, layout = "nicely") +
  geom_edge_link(aes(width = weight), alpha = 0.8) +
  geom_node_point(aes(color = type)) +
  scale_edge_width(range = c(0.2, 2)) +
  labs(edge_width = "No. of publications",
       title = "Author Publications",
       caption = "Heidi Blackburn and Jason Heppler") +
  theme_jah() +
  theme_graph()
```

Graph of authors and their co-authors, colored by gender. (NB: This isn't working yet.)

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# Graph: Authors and co-authors colored by gender
ggraph(gender_tidy) +
  geom_edge_link(aes(width = weight), alpha = 0.8) +
  geom_node_point(aes(color = gender)) +
  scale_edge_width(range = c(0.2, 2)) +
  labs(edge_width = "No. of publications",
       title = "Journal Publications",
       subtitle = "Authors corresponding journals.",
       caption = "Heidi Blackburn and Jason Heppler") +
  theme_graph() 
```

## Summary statistics

### Number of journals that accounted for % of references.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# % of journals that accounted for % of the references 
# (i.e. 5% of the journals were responsible for 60% of the citations)

pub_counts$pct <- paste0(round((pub_counts$n / sum(pub_counts$n)) * 100, 2), "%")
DT::datatable(pub_counts)
```

### Number of journals.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# # of journals (X%)
DT::datatable(count(journals, pubtitle, sort = TRUE))
```

### Number of conference proceedings.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# # of conference proceedings (X%)

DT::datatable(count(conferences, pubtitle, sort = TRUE))
```

### Top three journal publications and their counts. ASEE at 32, Sex Roles at 21, and Journal of Women and Minorities in Science and Engineering at 21.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# NAME HERE had the greatest number of publications at XX, 
# followed by NAME HERE with X, and NAME HERE with XX

DT::datatable(count(data, pubtitle, sort = TRUE))
```

### Top twenty journals that publish articles on women in STEM in higher education.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# top twenty journals that publish articles on women in STEM in higher education and the ranking of publisher by number of articles (table)

DT::datatable(journals %>% 
  group_by(pubtitle) %>% 
  tally %>% 
  arrange(desc(n)) %>% 
  head(20)
)
```

### Number of authors and their count of articles.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# # of authors identified

DT::datatable(count(gender_predicted_final, author, sort = TRUE))
```

### Number of authors that published *n*% of the works.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# # of authors who have published X% of the works
author_counts <- count(gender_predicted_final, author, sort = TRUE)
author_counts$pct <- paste0((author_counts$n / sum(pub_counts$n) * 100), "%")
DT::datatable(author_counts)
```

### Percentage of authors that write with a co-author.

*TODO: code to write*

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# X% of authors who write with a co-author
# TODO

```

### Number of publishers and percentage of journals they own.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# # of publishers and % of journals they own (within sample)
pub_owner <- data %>% select(publisher, pubtitle)
pub_owner_count <- count(data, publisher, sort = TRUE)
pub_owner_count$pct <- paste0(round(pub_owner_count$n / sum(pub_owner_count$n) * 100, 3), "%")
DT::datatable(pub_owner_count)
```

### Top publisher with top three journal titles

**NB**: The trick here is that there are ties in the dataset, and my code doesn't account for those ties (it was pretty tricky to get this working). If necessary, I might be able to modify this to try and show all cases where there are ties. Sort by `publisher` to see the top publishers and their corresponding top three journal titles.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# Top publisher with topic three journal names (this might be trickier)
pub_ownership_titles_count <- data %>% 
  group_by(pubtitle) %>% summarize(pub_title_count = n())

pub_ownership_publishers_count <- data  %>% 
  group_by(publisher) %>% summarize(pub_publisher_count = n())

pub_ownership <- data %>% 
  select(publisher, pubtitle) %>% 
  left_join(pub_ownership_publishers_count, by = "publisher")
pub_ownership <- pub_ownership %>% 
  left_join(pub_ownership_titles_count, by ="pubtitle")

# removes all duplicates
#pub_ownership %>% 
#  arrange(desc(pub_publisher_count), desc(pub_title_count)) %>% 
#  distinct(publisher, .keep_all=T) %>%
#  View()

# top three
DT::datatable(pub_ownership %>% 
  arrange(desc(pub_publisher_count), desc(pub_title_count)) %>% 
  distinct(pubtitle, .keep_all=TRUE) %>% 
  group_by(publisher) %>% slice(1:3)
)
 
#sampled <- pub_ownership %>% sample_n(50)
#dput(sampled)
```

### Percentage increase in journals published between 2007 and 2018.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# % increase in journals published between 2007 and 2018
d <- gender_predicted_final %>% 
  group_by(date) %>% 
  tally %>% 
  arrange(desc(n))

d <- slice(d, 1:(n()-1))

d2 <- d %>% 
  arrange(date) %>% 
  mutate(pct.change = (n - lag(n)) / lag(n) * 100)

DT::datatable(d2)
```

Total percentage increase between 2007 and 2018 across proceedings and journals.

```{r}
perc_increase_low <- data %>% filter(date == 2007) %>% count()
perc_increase_high <- data %>% filter(date == 2018) %>% count()
  
paste0(round(perc_increase_high/ perc_increase_low * 100, 2), "%")
```

### Percentage increase in journal articles from top publishing journals.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# % increase in journal articles from top publishing journals (if true)

```

### Percentage increase in conference proceeding publications.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# % increase in conference proceeding publications

```

### Percentage of studies published outside traditional STEM journals.

```{r, error=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
# % of studies published outside traditional STEM journals

```